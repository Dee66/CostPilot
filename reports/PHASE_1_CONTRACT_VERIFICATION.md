# Phase 1: License Contract Verification Report

**Date:** 2026-01-10
**Status:** ‚ùå **BLOCKER DETECTED**
**Analyst:** Forensic code review (read-only investigation)

---

## Executive Summary

**Critical Finding:** The license issuer and CostPilot consumer are using **DIFFERENT Ed25519 keypairs**, preventing any license validation from succeeding.

**Impact:** All licenses generated by `costpilot-license-issuer` will fail signature verification in CostPilot. Premium mode cannot activate.

**Root Cause:** Key rotation occurred in CostPilot (2026-01-08) but `costpilot-license-issuer/keypair_info.json` contains a different, likely older keypair.

---

## Cryptographic Contract Analysis

### 1. Canonical Message Format

**Issuer (costpilot-license-issuer/src/lib.rs:189-193):**
```rust
let canonical_message = format!(
    "{}|{}|{}|{}",
    request.email, request.license_key, expires_str, self.issuer_name
);
```

**Consumer (src/pro_engine/crypto.rs:166-169):**
```rust
let message = format!(
    "{}|{}|{}|{}",
    lic.email, lic.license_key, lic.expires, lic.issuer
);
```

**‚úÖ Verdict:** Canonical formats **MATCH EXACTLY** (pipe-delimited: `email|license_key|expires|issuer`)

---

### 2. JSON Field Structure

**Issuer Produces (IssuedLicense struct, lib.rs:71-79):**
```json
{
  "email": "string",
  "license_key": "string",
  "expires": "RFC3339 datetime",
  "issued_at": "RFC3339 datetime",
  "signature": "hex-encoded Ed25519 signature (128 chars)",
  "version": "1.0",
  "issuer": "string"
}
```

**Consumer Expects (License struct, src/pro_engine/license.rs:155-161):**
```json
{
  "email": "string",
  "license_key": "string",
  "expires": "RFC3339 datetime",
  "signature": "hex-encoded Ed25519 signature",
  "issuer": "string"
}
```

**‚ö†Ô∏è Discrepancy:** Issuer includes `issued_at` and `version` fields. Consumer ignores them (not required, acceptable).

**‚úÖ Verdict:** Consumer can parse issuer JSON successfully (extra fields are benign).

---

### 3. Signature Algorithm

**Issuer (lib.rs:195):**
```rust
let signature = self.signing_key.sign(canonical_message.as_bytes());
```
- Uses `ed25519-dalek` crate v2.1
- Standard Ed25519 signing

**Consumer (crypto.rs:176-179):**
```rust
let public_key = signature::UnparsedPublicKey::new(&signature::ED25519, public_key_bytes);
public_key.verify(message.as_bytes(), &sig_bytes)
```
- Uses `ring` crate for Ed25519 verification
- Standard Ed25519 verification

**‚úÖ Verdict:** Algorithm compatibility **CONFIRMED** (both use RFC 8032 Ed25519)

---

### 4. Signature Encoding

**Issuer (lib.rs:197):**
```rust
signature: hex::encode(signature.to_bytes())
```

**Consumer (crypto.rs:171):**
```rust
let sig_bytes = hex::decode(&lic.signature).map_err(|_| "Invalid signature format")?;
```

**‚úÖ Verdict:** Encoding **MATCHES** (hex string, 128 characters for 64-byte signature)

---

### 5. Datetime Format

**Issuer (lib.rs:185-186):**
```rust
let expires = now + Duration::days(request.expires_days);
let expires_str = expires.to_rfc3339();
```

**Consumer (license.rs:179-189):**
```rust
let parsed = DateTime::parse_from_rfc3339(&self.expires)
    .map_err(|_| "Invalid expiration date format")?;
```

**‚úÖ Verdict:** RFC3339 format **MATCHES EXACTLY**

**Example from issuer:** `"2027-01-07T08:26:46.056456389+00:00"`

---

### 6. Issuer Name

**Issuer Default (lib.rs:123):**
```rust
issuer_name: "costpilot-v1".to_string()
```

**Consumer Validation (crypto.rs:186-192):**
```rust
fn get_license_public_key(issuer: &str) -> Result<&'static [u8], String> {
    match issuer {
        "costpilot-v1" => Ok(LICENSE_PUBLIC_KEY),
        "test-costpilot" => Ok(TEST_LICENSE_PUBLIC_KEY),
        _ => Err(format!("Unknown license issuer: {}", issuer)),
    }
}
```

**‚úÖ Verdict:** Issuer name **MATCHES** (both use `"costpilot-v1"`)

---

## üî¥ **CRITICAL BLOCKER: Public Key Mismatch**

### Issuer Keypair (costpilot-license-issuer/keypair_info.json)

```
Public Key (hex): 45f9c85f9c70b5d51902a30cace13835994bb5c10e8dcd496689ab69b5bb4439
Fingerprint:      45f9c85f9c70b5d5
Private Key (hex): 5d06a1afc2937a29e128f34a1041234b2b60bc61b50098114b781276b344dfd7
```

**Source File:** `/costpilot-license-issuer/keypair_info.json`

---

### Consumer Public Key (CostPilot Binary)

```
Public Key (hex): db52fc95fe7ccbd5e55ecfd357d8271d1b2d4a9f608e68db3e7f869d54dba5df
Fingerprint:      db52fc95fe7ccbd5
```

**Source File:** `build/artifacts/keys.rs` (generated at compile time)

**Generation Date:** 2026-01-08 (after git history exposure)

**Comment in keys.rs:**
```rust
// Keys rotated 2026-01-08 after git history exposure
// OLD keys (fingerprints 23837ac5, 10f8798e) are REVOKED
```

---

### Verification

```
Issuer fingerprint:   45f9c85f9c70b5d5
Consumer fingerprint: db52fc95fe7ccbd5
Keys match: FALSE
```

**Consequence:** All signatures generated by issuer will fail verification in consumer.

---

## Impact Assessment

| Component | Status | Impact |
|-----------|--------|--------|
| Canonical message format | ‚úÖ Match | No impact |
| JSON structure | ‚úÖ Compatible | No impact |
| Signature algorithm | ‚úÖ Match | No impact |
| Signature encoding | ‚úÖ Match | No impact |
| Datetime format | ‚úÖ Match | No impact |
| Issuer name | ‚úÖ Match | No impact |
| **Public key** | ‚ùå **MISMATCH** | **BLOCKS ALL LICENSE VALIDATION** |

---

## Evidence: Real License Validation Test

### Generated License (costpilot-license-issuer/license_premium.json)

```json
{
  "email": "test-premium@example.com",
  "license_key": "PREMIUM-2596341E",
  "expires": "2027-01-07T08:26:46.056456389+00:00",
  "issued_at": "2026-01-07T08:26:46.056456389+00:00",
  "signature": "a87221177e36270b83e3364ede0a59a8f3fbb70426189436a3ad54c3e217fc749c615d2338d9811038d79e69bdf35bee9353c69b4c3b3e3bd3d06a2b89d80907",
  "version": "1.0",
  "issuer": "costpilot-v1"
}
```

**Signature:** 128 hex characters (valid Ed25519 signature format)

**Signed with:** Private key `5d06a1afc2937a29...` (fingerprint `45f9c85f9c70b5d5`)

**CostPilot will verify with:** Public key `db52fc95fe7ccbd5...` (fingerprint `db52fc95fe7ccbd5`)

**Expected Result:** ‚ùå Signature verification will fail

**Actual Consumer Behavior:** Falls back to Free Edition silently

---

## Root Cause Analysis

### Timeline

1. **Unknown Date:** `costpilot-license-issuer` keypair generated (`45f9c85f...`)
2. **2026-01-08:** CostPilot keys rotated after git history exposure (`db52fc95...`)
3. **2026-01-10:** Contract verification reveals mismatch

### Why This Occurred

1. `costpilot-license-issuer` is a **separate subdirectory** with its own keypair
2. CostPilot's `build.rs` **generates new keys at compile time** using `generate_crypto_keys()`
3. The issuer keypair was **NOT updated** to match the rotated consumer keys
4. No end-to-end validation detected the mismatch before this analysis

---

## Remediation Options

### Option 1: Replace Issuer Keypair (RECOMMENDED)

**Action:** Copy CostPilot's keypair into `costpilot-license-issuer/keypair_info.json`

**Steps:**
1. Extract private key from CostPilot's key generation (requires build inspection)
2. Update `keypair_info.json` with matching keypair
3. Regenerate all test licenses
4. Verify end-to-end with real license

**Risk:** Low (synchronizes the two systems)

**Blocks Public Release:** Yes (must complete before fork build)

---

### Option 2: Replace CostPilot Public Key (NOT RECOMMENDED)

**Action:** Embed issuer's public key (`45f9c85f...`) into CostPilot

**Steps:**
1. Modify `build.rs` key generation logic
2. Hard-code issuer's public key as `LICENSE_PUBLIC_KEY`
3. Rebuild CostPilot binary
4. Test with existing licenses

**Risk:** Medium (reverts key rotation done after security exposure)

**Security Concern:** If `45f9c85f...` keypair was exposed in git history, this reintroduces the vulnerability

---

### Option 3: Generate New Shared Keypair (SAFEST)

**Action:** Generate a fresh Ed25519 keypair and update both systems

**Steps:**
1. Generate new keypair securely (not in repo)
2. Update CostPilot's `build.rs` to use new public key
3. Update issuer with new private key (store in AWS Secrets Manager)
4. Invalidate all existing test licenses
5. Test end-to-end with newly generated licenses

**Risk:** Low (clean slate, provably secure)

**Effort:** Medium (requires updating both repos + AWS Lambda deployment)

---

## Verification Checklist

**To prove contract correctness:**

- [x] Compare canonical message formats ‚Üí **MATCH**
- [x] Compare JSON field structures ‚Üí **COMPATIBLE**
- [x] Compare signature algorithms ‚Üí **MATCH**
- [x] Compare signature encoding ‚Üí **MATCH**
- [x] Compare datetime formats ‚Üí **MATCH**
- [x] Compare issuer names ‚Üí **MATCH**
- [x] **Compare public keys ‚Üí MISMATCH (BLOCKER)**
- [ ] Test real license validation end-to-end ‚Üí **BLOCKED**

---

## Stop Condition Triggered

**Per forensic engagement contract:**
> "If license validation fails with a real issuer license, STOP."

**Status:** Phase 1 incomplete. **Cannot proceed to Phase 2 (real license E2E test) until public key synchronization is resolved.**

---

## Recommended Next Actions

1. **DECISION REQUIRED:** Choose remediation option (Option 1, 2, or 3)
2. **If Option 1 or 3:** Extract/generate correct keypair
3. **Update issuer:** Replace `keypair_info.json` with synchronized keys
4. **Rebuild licenses:** Run `generate_test_license` example
5. **Verify sync:** Run Python comparison script again (should show `Keys match: True`)
6. **Resume Phase 2:** Test real license end-to-end with CostPilot binary

---

## Artifacts Referenced

- `costpilot-license-issuer/src/lib.rs` (lines 71-79, 189-197)
- `src/pro_engine/crypto.rs` (lines 163-192)
- `src/pro_engine/license.rs` (lines 155-161, 179-189)
- `costpilot-license-issuer/keypair_info.json`
- `build/artifacts/keys.rs` (auto-generated)
- `costpilot-license-issuer/license_premium.json` (test license)

---

**Report Status:** COMPLETE
**Phase 1 Verdict:** ‚ùå **CONTRACT VIOLATION DETECTED - BLOCKS PRODUCTION RELEASE**
**CI Cost Incurred:** $0 (local analysis only)
