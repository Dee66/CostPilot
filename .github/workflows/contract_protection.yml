name: Contract Protection

on:
  pull_request:
    paths:
      - 'build.rs'
      - 'src/pro_engine/license.rs'
      - 'src/pro_engine/crypto.rs'
      - 'tests/contract_protection_tests.rs'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-license-contract:
    name: Verify Immutable License Contract
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run contract protection tests
        run: |
          cargo test --test contract_protection_tests --verbose
        env:
          RUST_BACKTRACE: 1

      - name: Verify public key fingerprint
        run: |
          echo "Extracting embedded public key fingerprint..."

          # Expected fingerprint (IMMUTABLE)
          EXPECTED_LICENSE_FP="db52fc95fe7ccbd5"
          EXPECTED_WASM_FP="8db250f6bf7cdf01"

          # Extract from build.rs
          LICENSE_KEY=$(grep -A1 "NEW_LICENSE_PUBLIC_KEY_HEX" build.rs | grep '"' | cut -d'"' -f2)
          WASM_KEY=$(grep -A1 "NEW_WASM_PUBLIC_KEY_HEX" build.rs | grep '"' | cut -d'"' -f2)

          # Get fingerprints (first 16 hex chars = 8 bytes)
          ACTUAL_LICENSE_FP="${LICENSE_KEY:0:16}"
          ACTUAL_WASM_FP="${WASM_KEY:0:16}"

          echo "Expected LICENSE fingerprint: $EXPECTED_LICENSE_FP"
          echo "Actual LICENSE fingerprint:   $ACTUAL_LICENSE_FP"
          echo "Expected WASM fingerprint: $EXPECTED_WASM_FP"
          echo "Actual WASM fingerprint:   $ACTUAL_WASM_FP"

          # Fail if mismatch
          if [ "$ACTUAL_LICENSE_FP" != "$EXPECTED_LICENSE_FP" ]; then
            echo "❌ LICENSE PUBLIC KEY HAS CHANGED!"
            echo ""
            echo "This is a BREAKING CHANGE that will invalidate ALL existing licenses."
            echo ""
            echo "If this is intentional (key rotation):"
            echo "  1. Update EXPECTED_LICENSE_FP in this workflow"
            echo "  2. Update tests/contract_protection_tests.rs"
            echo "  3. Document rotation in CONTRACT.md"
            echo "  4. Notify all license holders"
            echo "  5. Update issuer with new private key"
            echo ""
            echo "If this is unintentional:"
            echo "  1. Revert changes to build.rs"
            echo "  2. Run: git diff build.rs"
            exit 1
          fi

          if [ "$ACTUAL_WASM_FP" != "$EXPECTED_WASM_FP" ]; then
            echo "❌ WASM PUBLIC KEY HAS CHANGED!"
            echo "This affects ProEngine WASM verification."
            exit 1
          fi

          echo "✅ Public keys verified - no changes detected"

      - name: Verify contract module markers
        run: |
          echo "Checking for IMMUTABLE LICENSE CONTRACT markers..."

          if ! grep -q "IMMUTABLE LICENSE CONTRACT" src/pro_engine/license.rs; then
            echo "❌ Missing IMMUTABLE marker in license.rs"
            exit 1
          fi

          if ! grep -q "IMMUTABLE LICENSE CONTRACT" src/pro_engine/crypto.rs; then
            echo "❌ Missing IMMUTABLE marker in crypto.rs"
            exit 1
          fi

          echo "✅ Contract markers present"

      - name: Verify duration tests exist
        run: |
          echo "Verifying duration validation tests..."

          cargo test --test license_duration_tests --list | grep "test.*30.*day" || {
            echo "❌ Missing 30-day license tests"
            exit 1
          }

          cargo test --test license_duration_tests --list | grep "test.*365.*day" || {
            echo "❌ Missing 365-day license tests"
            exit 1
          }

          echo "✅ Duration tests present"

      - name: Verify E2E tests exist
        run: |
          echo "Verifying real license E2E tests..."

          cargo test --test license_e2e_real_tests --list | grep "test.*30.*day.*premium" || {
            echo "❌ Missing 30-day Premium activation test"
            exit 1
          }

          cargo test --test license_e2e_real_tests --list | grep "test.*365.*day.*premium" || {
            echo "❌ Missing 365-day Premium activation test"
            exit 1
          }

          cargo test --test license_e2e_real_tests --list | grep "test.*expired.*free" || {
            echo "❌ Missing expired license test"
            exit 1
          }

          cargo test --test license_e2e_real_tests --list | grep "test.*invalid.*signature" || {
            echo "❌ Missing invalid signature test"
            exit 1
          }

          echo "✅ E2E tests present"

      - name: Final verification summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ License Contract Verification PASSED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Verified:"
          echo "  ✅ Public keys unchanged (db52fc95, 8db250f6)"
          echo "  ✅ Contract modules marked IMMUTABLE"
          echo "  ✅ Duration tests present (30-day, 365-day)"
          echo "  ✅ E2E tests present (Premium, Free, expired)"
          echo "  ✅ Contract protection tests passed (10 tests)"
          echo ""
          echo "Contract Status: STABLE"
