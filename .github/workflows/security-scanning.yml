name: Security Scanning

on:
  push:
    branches: [ main ]
    paths:
      - 'products/costpilot/**'
      - 'scripts/security_review.sh'
  pull_request:
    branches: [ main ]
    paths:
      - 'products/costpilot/**'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - dependencies-only

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for security analysis

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Install security tools
      run: |
        cd products/costpilot

        # Install cargo-audit for dependency vulnerability scanning
        cargo install cargo-audit --locked

        # Install cargo-deny for additional dependency analysis
        cargo install cargo-deny --locked

        # Install cargo-tarpaulin for coverage analysis (security aspect)
        cargo install cargo-tarpaulin --locked

    - name: Run security review script
      run: |
        cd products/costpilot
        chmod +x ../../scripts/security_review.sh
        ../../scripts/security_review.sh

    - name: Run cargo audit (dependencies)
      run: |
        cd products/costpilot
        cargo audit --format json > security-audit.json || true
        cat security-audit.json

    - name: Run cargo deny checks
      run: |
        cd products/costpilot
        cargo deny check --format json > deny-check.json || true
        cat deny-check.json

    - name: Check for secrets in code
      run: |
        cd products/costpilot

        # Use git-secrets if available, otherwise use basic grep
        if command -v git-secrets &> /dev/null; then
          git-secrets --scan --recursive . > secrets-scan.txt 2>&1 || true
        else
          echo "git-secrets not available, using basic pattern matching"
          # Basic secret pattern detection
          grep -r -i "password\|secret\|key\|token\|api_key\|aws_access_key_id\|aws_secret_access_key" --include="*.rs" --include="*.toml" --include="*.md" . | grep -v "example\|test\|mock\|fake" > secrets-scan.txt || true
        fi

        cat secrets-scan.txt

    - name: Security linting with clippy
      run: |
        cd products/costpilot
        cargo clippy -- -W clippy::pedantic -W clippy::nursery -W clippy::unwrap_used -W clippy::expect_used -W clippy::panic -D clippy::print_stdout -D clippy::print_stderr > clippy-security.log 2>&1 || true
        cat clippy-security.log

    - name: Build and analyze binary security
      run: |
        cd products/costpilot
        cargo build --release

        # Check binary for security issues
        if command -v hardentools &> /dev/null; then
          hardentools ./target/release/costpilot > binary-security-analysis.txt 2>&1 || true
        else
          echo "hardentools not available for binary analysis"
          # Basic binary checks
          file ./target/release/costpilot > binary-security-analysis.txt
          echo "Binary size: $(stat -c%s ./target/release/costpilot) bytes" >> binary-security-analysis.txt
        fi

        cat binary-security-analysis.txt

    - name: Generate SBOM (Software Bill of Materials)
      run: |
        cd products/costpilot

        # Generate basic SBOM using cargo metadata
        cargo metadata --format-version 1 --no-deps | jq '{
          spdxVersion: "SPDX-2.3",
          dataLicense: "CC0-1.0",
          SPDXID: "SPDXRef-DOCUMENT",
          name: "CostPilot SBOM",
          creationInfo: {
            created: now | strftime("%Y-%m-%dT%H:%M:%SZ"),
            creators: ["Tool: cargo-metadata"]
          },
          packages: .packages | map({
            SPDXID: ("SPDXRef-Package-" + .name),
            name: .name,
            versionInfo: .version,
            downloadLocation: (.source.repr // "NOASSERTION"),
            filesAnalyzed: false,
            copyrightText: "NOASSERTION",
            licenseConcluded: (.license // "NOASSERTION"),
            licenseDeclared: (.license // "NOASSERTION")
          })
        }' > sbom.json

        cat sbom.json

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results-${{ github.run_number }}
        path: |
          products/costpilot/code-review-results/
          products/costpilot/security-audit.json
          products/costpilot/deny-check.json
          products/costpilot/secrets-scan.txt
          products/costpilot/clippy-security.log
          products/costpilot/binary-security-analysis.txt
          products/costpilot/sbom.json
        retention-days: 30

    - name: Security scan summary
      if: always()
      run: |
        echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        cd products/costpilot

        # Count vulnerabilities
        AUDIT_VULNS=$(jq '.vulnerabilities.count // 0' security-audit.json 2>/dev/null || echo "0")
        echo "- **Dependency Vulnerabilities**: $AUDIT_VULNS" >> $GITHUB_STEP_SUMMARY

        # Count secrets found
        SECRET_COUNT=$(wc -l < secrets-scan.txt 2>/dev/null || echo "0")
        echo "- **Potential Secrets Found**: $SECRET_COUNT" >> $GITHUB_STEP_SUMMARY

        # Check clippy results
        CLIPPY_ISSUES=$(grep -c "warning:\|error:" clippy-security.log 2>/dev/null || echo "0")
        echo "- **Clippy Security Issues**: $CLIPPY_ISSUES" >> $GITHUB_STEP_SUMMARY

        # Check security review results
        if [ -f "code-review-results/security_vulnerabilities.count" ]; then
          SECURITY_VULNS=$(cat code-review-results/security_vulnerabilities.count)
          echo "- **Security Review Issues**: $SECURITY_VULNS" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Overall Security Status" >> $GITHUB_STEP_SUMMARY

        TOTAL_ISSUES=$((AUDIT_VULNS + SECRET_COUNT + CLIPPY_ISSUES))

        if [ "$TOTAL_ISSUES" -eq 0 ]; then
          echo "âœ… **All security checks passed**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Security issues detected**: $TOTAL_ISSUES total" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Fail on critical security issues
      if: always()
      run: |
        cd products/costpilot

        # Critical failures
        CRITICAL_ISSUES=0

        # High-severity vulnerabilities
        HIGH_VULNS=$(jq '.vulnerabilities.list[]? | select(.severity == "high" or .severity == "critical") | .severity' security-audit.json 2>/dev/null | wc -l || echo "0")
        CRITICAL_ISSUES=$((CRITICAL_ISSUES + HIGH_VULNS))

        # Secrets found
        if [ -s "secrets-scan.txt" ]; then
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
        fi

        if [ "$CRITICAL_ISSUES" -gt 0 ]; then
          echo "ðŸš¨ Critical security issues detected: $CRITICAL_ISSUES"
          echo "Review the security scan results and fix issues before merging."
          exit 1
        fi

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.scan_type == 'dependencies-only'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install security tools
      run: |
        cargo install cargo-audit --locked
        cargo install cargo-deny --locked

    - name: Run comprehensive dependency analysis
      run: |
        cd products/costpilot

        echo "ðŸ” Running cargo audit..."
        cargo audit --format json > dependency-audit.json

        echo "ðŸ” Running cargo deny checks..."
        cargo deny check --format json > dependency-deny.json

        echo "ðŸ” Checking for outdated dependencies..."
        cargo outdated --format json > dependency-outdated.json || echo '{"error": "cargo-outdated not available"}' > dependency-outdated.json

    - name: Upload dependency scan results
      uses: actions/upload-artifact@v4
      with:
        name: dependency-scan-results-${{ github.run_number }}
        path: |
          products/costpilot/dependency-audit.json
          products/costpilot/dependency-deny.json
          products/costpilot/dependency-outdated.json

    - name: Dependency security alert
      if: failure()
      run: |
        echo "ðŸš¨ Dependency security vulnerabilities detected!"
        echo "Review the dependency scan results and update vulnerable dependencies."
