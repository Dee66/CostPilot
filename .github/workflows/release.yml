name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run ProEngine loader tests
        run: cargo test --test pro_engine_loader_unit_tests

      - name: Run WASM runtime tests
        run: cargo test --test wasm_runtime_tests

      - name: Run Pro Engine loader tests
        run: cargo test --test pro_engine_loader_tests

      - name: Build release
        run: cargo build --release

      - name: Package
        env:
          TARGET: linux-amd64
        run: bash build/package/make_release.sh

      - name: Validate archives
        run: |
          bash build/package/validate_release.sh dist/costpilot-linux-amd64.zip
          bash build/package/validate_release.sh dist/costpilot-linux-amd64.tar.gz

      - name: Verify release policy
        run: bash packaging/signing/verify_release_policy.sh

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-linux-amd64.zip
          path: dist/costpilot-linux-amd64.zip

      - name: Upload TAR.GZ
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-linux-amd64.tar.gz
          path: dist/costpilot-linux-amd64.tar.gz

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build release
        run: cargo build --release --target aarch64-apple-darwin

      - name: Copy binary to standard location
        run: |
          mkdir -p target/release
          cp target/aarch64-apple-darwin/release/costpilot target/release/

      - name: Package
        env:
          TARGET: macos-arm64
        run: bash build/package/make_release.sh

      - name: Validate archives
        run: |
          bash build/package/validate_release.sh dist/costpilot-macos-arm64.zip
          bash build/package/validate_release.sh dist/costpilot-macos-arm64.tar.gz

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-macos-arm64.zip
          path: dist/costpilot-macos-arm64.zip

      - name: Upload TAR.GZ
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-macos-arm64.tar.gz
          path: dist/costpilot-macos-arm64.tar.gz

  build-macos-amd64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Build release
        run: cargo build --release --target x86_64-apple-darwin

      - name: Copy binary to standard location
        run: |
          mkdir -p target/release
          cp target/x86_64-apple-darwin/release/costpilot target/release/

      - name: Package
        env:
          TARGET: macos-amd64
        run: bash build/package/make_release.sh

      - name: Validate archives
        run: |
          bash build/package/validate_release.sh dist/costpilot-macos-amd64.zip
          bash build/package/validate_release.sh dist/costpilot-macos-amd64.tar.gz

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-macos-amd64.zip
          path: dist/costpilot-macos-amd64.zip

      - name: Upload TAR.GZ
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-macos-amd64.tar.gz
          path: dist/costpilot-macos-amd64.tar.gz

  build-windows-amd64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release
        run: cargo build --release

      - name: Package
        shell: bash
        env:
          TARGET: windows-amd64
        run: bash build/package/make_release.sh

      - name: Validate archives
        shell: bash
        run: |
          bash build/package/validate_release.sh dist/costpilot-windows-amd64.zip
          bash build/package/validate_release.sh dist/costpilot-windows-amd64.tar.gz

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-windows-amd64.zip
          path: dist/costpilot-windows-amd64.zip

      - name: Upload TAR.GZ
        uses: actions/upload-artifact@v4
        with:
          name: costpilot-windows-amd64.tar.gz
          path: dist/costpilot-windows-amd64.tar.gz

  sign-and-release:
    runs-on: ubuntu-latest
    needs: [build-linux-amd64, build-macos-arm64, build-macos-amd64, build-windows-amd64]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Generate checksum file
        working-directory: dist
        run: |
          sha256sum *.zip *.tar.gz | sort > sha256sum.txt
          cat sha256sum.txt

      - name: Generate ephemeral signing key (CI-only)
        run: |
          mkdir -p build/keys
          chmod +x packaging/signing/generate_keypair.sh
          bash packaging/signing/generate_keypair.sh build/keys ci_signing

      - name: Sign checksums (Ed25519)
        run: |
          chmod +x packaging/signing/sign_checksum_ed25519.sh
          bash packaging/signing/sign_checksum_ed25519.sh dist/sha256sum.txt build/keys/ci_signing.pem dist/sha256sum.txt.sig

      - name: Verify signature (CI smoke)
        run: |
          chmod +x packaging/signing/verify_checksum_ed25519.sh
          bash packaging/signing/verify_checksum_ed25519.sh dist/sha256sum.txt dist/sha256sum.txt.sig build/keys/ci_signing.pub.pem

      - name: Generate license token (dev)
        if: env.RELEASE_SIGNING == 'true'
        env:
          SIGNING_SECRET: ${{ secrets.SIGNING_SECRET }}
          SOURCE_DATE_EPOCH: ${{ github.event.head_commit.timestamp }}
        run: |
          chmod +x packaging/signing/generate_license_token.sh
          bash packaging/signing/generate_license_token.sh \
            "demo-license" \
            "dev@example.com" \
            "2026-12-31T23:59:59Z" \
            "dist/license.json"

      - name: Sign checksums
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          ED25519_PRIV: ${{ secrets.ED25519_PRIV }}
          SIGNING_SECRET: ${{ secrets.SIGNING_SECRET }}
        run: |
          chmod +x packaging/signing/sign_checksums.sh
          bash packaging/signing/sign_checksums.sh dist dist/sha256sum.txt dist/sha256sum.sig

      - name: Verify signature
        env:
          SIGNING_SECRET: ${{ secrets.SIGNING_SECRET }}
        run: |
          chmod +x packaging/signing/verify_signature.sh
          if [[ -f packaging/signing/public.key ]]; then
            bash packaging/signing/verify_signature.sh dist/sha256sum.txt dist/sha256sum.sig packaging/signing/public.key
          else
            bash packaging/signing/verify_signature.sh dist/sha256sum.txt dist/sha256sum.sig
          fi

      - name: Verify release bundles
        env:
          SIGNING_SECRET: ${{ secrets.SIGNING_SECRET }}
        run: |
          chmod +x packaging/verify_release_bundle.sh
          for artifact in dist/*.tar.gz dist/*.zip; do
            [[ -f "$artifact" ]] || continue
            bash packaging/verify_release_bundle.sh "$artifact" dist/sha256sum.txt dist/sha256sum.sig packaging/signing/public.key || true
          done

      - name: Verify publisher signature (release)
        if: secrets.PUBLISHER_PUBKEY != ''
        env:
          PUBLISHER_PUBKEY: ${{ secrets.PUBLISHER_PUBKEY }}
        run: |
          echo "$PUBLISHER_PUBKEY" > build/publisher.pub.pem
          chmod +x packaging/signing/verify_checksum_ed25519.sh
          bash packaging/signing/verify_checksum_ed25519.sh dist/sha256sum.txt dist/sha256sum.txt.sig build/publisher.pub.pem

      - name: Upload checksum and signature
        uses: actions/upload-artifact@v4
        with:
          name: checksums-and-signatures
          path: |
            dist/sha256sum.txt
            dist/sha256sum.sig
            dist/license.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.zip
            dist/*.tar.gz
            dist/sha256sum.txt
            dist/sha256sum.sig
            dist/license.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
