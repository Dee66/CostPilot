name: Tests and Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Run unit tests
        run: cargo test --lib --all-features
      
      - name: Run doc tests
        run: cargo test --doc

  # Integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Run integration tests
        run: cargo test --test 'test_*' --all-features

  # E2E tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Build binary
        run: cargo build --release
      
      - name: Run E2E tests
        run: cargo test --test 'e2e_*' --all-features

  # Code coverage
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Generate coverage
        run: cargo tarpaulin --config tarpaulin.toml --verbose
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
      
      - name: Archive coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/
      
      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep -oP 'Coverage: \K[\d.]+' coverage/index.html | head -1)
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below 90% threshold"
            exit 1
          fi
          echo "✅ Coverage ${COVERAGE}% meets threshold"

  # Property-based tests
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Run property tests
        run: cargo test --test 'prop_*' --release

  # Snapshot tests
  snapshot-tests:
    name: Snapshot Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Run snapshot tests
        run: cargo test --test 'snap_*'
      
      - name: Check for snapshot changes
        run: |
          if git diff --exit-code tests/snapshots/; then
            echo "✅ All snapshots match"
          else
            echo "❌ Snapshot changes detected"
            git diff tests/snapshots/
            exit 1
          fi

  # Fuzz tests (nightly)
  fuzz-tests:
    name: Fuzz Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
      
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      
      - name: Run fuzz tests (extended)
        run: |
          cargo fuzz list | while read target; do
            timeout 1800 cargo fuzz run "$target" -- -max_total_time=1800 || true
          done
      
      - name: Collect crash artifacts
        run: |
          if [ -d fuzz/artifacts ]; then
            mkdir -p fuzz/fixtures
            cp -r fuzz/artifacts/* fuzz/fixtures/ 2>/dev/null || true
          fi
      
      - name: Upload fuzz artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: fuzz-artifacts
          path: fuzz/artifacts/

  # Extended fuzzing (scheduled)
  extended-fuzz:
    name: Extended Fuzz Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
      
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      
      - name: Run extended fuzz tests
        run: |
          cargo fuzz list | while read target; do
            timeout 3600 cargo fuzz run "$target" -- -max_total_time=3600 || true
          done
      
      - name: Collect and store crash seeds
        run: |
          if [ -d fuzz/artifacts ]; then
            mkdir -p fuzz/fixtures
            cp -r fuzz/artifacts/* fuzz/fixtures/ 2>/dev/null || true
            # Commit fixtures if there are changes
            if git diff --quiet fuzz/fixtures/; then
              echo "No new crash seeds to commit"
            else
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git add fuzz/fixtures/
              git commit -m "Add new fuzz crash seeds" || true
              git push || true
            fi
          fi
  mutation-tests:
    name: Mutation Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Install cargo-mutants
        run: cargo install cargo-mutants
      
      - name: Run mutation tests
        run: cargo mutants --timeout 300 --jobs 4
      
      - name: Upload mutation report
        uses: actions/upload-artifact@v3
        with:
          name: mutation-report
          path: mutants.out/

  # Performance regression
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      
      - name: Run benchmarks
        run: cargo bench --no-fail-fast
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: target/criterion/

  # Lint and format
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
