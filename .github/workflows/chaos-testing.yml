# MANUAL WORKFLOW - intentionally not automated. Run only when explicitly required.
name: Chaos Engineering Testing

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of chaos test to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - scenarios
          - recovery
          - gameday
          - injection
          - incident
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      intensity:
        description: 'Chaos intensity level'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - extreme

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  chaos-testing:
    name: Chaos Engineering Tests
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build CostPilot
        run: cargo build --release

      - name: Install chaos testing dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl wget

      - name: Create chaos results directory
        run: mkdir -p chaos-results

      - name: Run chaos engineering tests
        id: chaos_test
        run: |
          # Set test parameters based on inputs
          export CHAOS_TEST_DURATION="${{ inputs.intensity == 'low' && '5m' || inputs.intensity == 'medium' && '10m' || inputs.intensity == 'high' && '20m' || inputs.intensity == 'extreme' && '30m' || '10m' }}"
          export RECOVERY_TIME_SLA="900"
          export GAME_DAY_DURATION="2h"
          export FAILURE_INJECTION_SCENARIOS="${{ inputs.intensity == 'low' && '5' || inputs.intensity == 'medium' && '10' || inputs.intensity == 'high' && '15' || inputs.intensity == 'extreme' && '20' || '15' }}"

          # Run the specified chaos test
          ./scripts/run_chaos_testing.sh ${{ inputs.test_type || 'full' }}

      - name: Upload chaos test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-test-results-${{ inputs.test_type || 'full' }}-${{ inputs.intensity || 'medium' }}
          path: chaos-results/
          retention-days: 30

      - name: Generate chaos test report
        if: always()
        run: |
          echo "## Chaos Engineering Test Results" >> chaos-report.md
          echo "" >> chaos-report.md
          echo "**Test Type:** ${{ inputs.test_type || 'full' }}" >> chaos-report.md
          echo "**Environment:** ${{ inputs.environment || 'staging' }}" >> chaos-report.md
          echo "**Intensity:** ${{ inputs.intensity || 'medium' }}" >> chaos-report.md
          echo "**Execution Date:** $(date -Iseconds)" >> chaos-report.md
          echo "" >> chaos-report.md

          if [ -f "chaos-results/chaos-engineering-report.json" ]; then
            echo "**Overall Resilience Score:** $(jq -r '.overall_resilience_score' chaos-results/chaos-engineering-report.json)%" >> chaos-report.md
            echo "" >> chaos-report.md
            echo "**Compliance Status:**" >> chaos-report.md
            echo "- Netflix Simian Army: $(jq -r '.netflix_simian_army_compliance' chaos-results/chaos-engineering-report.json)" >> chaos-report.md
            echo "- Google SRE Practices: $(jq -r '.google_sre_practices_compliance' chaos-results/chaos-engineering-report.json)" >> chaos-report.md
            echo "" >> chaos-report.md
          fi

          echo "**Test Components Executed:**" >> chaos-report.md
          echo "- Chaos Scenarios (Network, Service, Resource)" >> chaos-report.md
          echo "- Recovery Testing (Failover, Consistency, RTO)" >> chaos-report.md
          echo "- Game Day Exercises (Cross-team participation)" >> chaos-report.md
          echo "- Failure Injection (Controlled outages)" >> chaos-report.md
          echo "- Incident Response (Alerting, Communication)" >> chaos-report.md

      - name: Comment on PR with chaos results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'chaos-report.md';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: Send chaos test notifications
        if: always()
        run: |
          # Send notifications based on test results
          if [ -f "chaos-results/chaos-engineering-report.json" ]; then
            RESILIENCE_SCORE=$(jq -r '.overall_resilience_score' chaos-results/chaos-engineering-report.json)

            if [ "$RESILIENCE_SCORE" -lt 80 ]; then
              echo "ðŸš¨ CHAOS TEST ALERT: Resilience score below 80% ($RESILIENCE_SCORE%)"
              # In a real implementation, this would send alerts to Slack/PagerDuty
            elif [ "$RESILIENCE_SCORE" -lt 90 ]; then
              echo "âš ï¸ CHAOS TEST WARNING: Resilience score below 90% ($RESILIENCE_SCORE%)"
            else
              echo "âœ… CHAOS TEST SUCCESS: Resilience score $RESILIENCE_SCORE%"
            fi
          fi

  chaos-regression-analysis:
    name: Chaos Regression Analysis
    runs-on: ubuntu-latest
    needs: chaos-testing
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download previous chaos results
        uses: actions/download-artifact@v4
        with:
          name: chaos-test-results-full-medium
          path: previous-results/

      - name: Download current chaos results
        uses: actions/download-artifact@v4
        with:
          name: chaos-test-results-${{ inputs.test_type || 'full' }}-${{ inputs.intensity || 'medium' }}
          path: current-results/

      - name: Analyze chaos regression
        run: |
          echo "## Chaos Regression Analysis" > regression-report.md
          echo "" >> regression-report.md

          # Compare resilience scores
          if [ -f "previous-results/chaos-engineering-report.json" ] && [ -f "current-results/chaos-results/chaos-engineering-report.json" ]; then
            PREV_SCORE=$(jq -r '.overall_resilience_score' previous-results/chaos-engineering-report.json)
            CURR_SCORE=$(jq -r '.overall_resilience_score' current-results/chaos-results/chaos-engineering-report.json)

            echo "**Previous Resilience Score:** $PREV_SCORE%" >> regression-report.md
            echo "**Current Resilience Score:** $CURR_SCORE%" >> regression-report.md

            if [ "$CURR_SCORE" -lt "$PREV_SCORE" ]; then
              DIFF=$((PREV_SCORE - CURR_SCORE))
              echo "**Regression Detected:** -$DIFF%" >> regression-report.md
              echo "" >> regression-report.md
              echo "**Action Required:** Investigate resilience degradation" >> regression-report.md
            else
              DIFF=$((CURR_SCORE - PREV_SCORE))
              echo "**Improvement Detected:** +$DIFF%" >> regression-report.md
            fi
          else
            echo "**No previous results available for comparison**" >> regression-report.md
          fi

      - name: Upload regression analysis
        uses: actions/upload-artifact@v4
        with:
          name: chaos-regression-analysis
          path: regression-report.md
          retention-days: 30

  chaos-dashboard-update:
    name: Update Chaos Dashboard
    runs-on: ubuntu-latest
    needs: [chaos-testing, chaos-regression-analysis]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download chaos results
        uses: actions/download-artifact@v4
        with:
          name: chaos-test-results-${{ inputs.test_type || 'full' }}-${{ inputs.intensity || 'medium' }}
          path: chaos-results/

      - name: Update chaos monitoring dashboard
        run: |
          # Create or update chaos dashboard
          cat > chaos-dashboard.md << 'EOF'
          # CostPilot Chaos Engineering Dashboard

          Generated: $(date -Iseconds)

          ## Chaos Testing Status Overview
          - **Last Chaos Test**: $(date)
          - **Overall Resilience Score**: $(jq -r '.overall_resilience_score // "N/A"' chaos-results/chaos-engineering-report.json)%
          - **Netflix Simian Army Compliance**: $(jq -r '.netflix_simian_army_compliance // "false"' chaos-results/chaos-engineering-report.json)
          - **Google SRE Practices Compliance**: $(jq -r '.google_sre_practices_compliance // "false"' chaos-results/chaos-engineering-report.json)

          ## Chaos Scenarios Results

          ### Network Partitioning
          - **Test Status**: $([ -f "chaos-results/scenarios/network_partitioning/analysis.json" ] && echo "âœ… COMPLETED" || echo "âŒ NOT RUN")
          - **Resilience Score**: $(jq -r '.chaos_resilience_score // "N/A"' chaos-results/scenarios/network_partitioning/analysis.json 2>/dev/null)%
          - **Average CPU Usage**: $(jq -r '.average_cpu_usage // "N/A"' chaos-results/scenarios/network_partitioning/analysis.json 2>/dev/null)%
          - **Average Memory Usage**: $(jq -r '.average_memory_usage // "N/A"' chaos-results/scenarios/network_partitioning/analysis.json 2>/dev/null)%

          ### Service Degradation
          - **Test Status**: $([ -f "chaos-results/scenarios/service_degradation/analysis.json" ] && echo "âœ… COMPLETED" || echo "âŒ NOT RUN")
          - **Resilience Score**: $(jq -r '.chaos_resilience_score // "N/A"' chaos-results/scenarios/service_degradation/analysis.json 2>/dev/null)%
          - **Max Errors Detected**: $(jq -r '.max_errors_detected // "N/A"' chaos-results/scenarios/service_degradation/analysis.json 2>/dev/null)

          ### Resource Exhaustion
          - **Test Status**: $([ -f "chaos-results/scenarios/resource_exhaustion/analysis.json" ] && echo "âœ… COMPLETED" || echo "âŒ NOT RUN")
          - **Resilience Score**: $(jq -r '.chaos_resilience_score // "N/A"' chaos-results/scenarios/resource_exhaustion/analysis.json 2>/dev/null)%
          - **Metrics Collected**: $(jq -r '.metrics_collected // "N/A"' chaos-results/scenarios/resource_exhaustion/analysis.json 2>/dev/null)

          ## Recovery Testing Results

          ### Automated Failover
          - **RTO Compliance**: $(jq -r '.rto_compliance // "false"' chaos-results/recovery/failover-test.json 2>/dev/null)
          - **Failover Time**: $(jq -r '.failover_time_seconds // "N/A"' chaos-results/recovery/failover-test.json 2>/dev/null)s

          ### Data Consistency
          - **Data Consistent**: $(jq -r '.data_consistent // "false"' chaos-results/recovery/consistency-test.json 2>/dev/null)
          - **Inconsistencies Detected**: $(jq -r '.inconsistencies_detected // "N/A"' chaos-results/recovery/consistency-test.json 2>/dev/null)

          ### RTO Compliance
          - **RTO SLA Met**: $(jq -r '.rto_sla_met // "false"' chaos-results/recovery/rto-test.json 2>/dev/null)
          - **Average Recovery Time**: $(jq -r '.average_recovery_time_seconds // "N/A"' chaos-results/recovery/rto-test.json 2>/dev/null)s

          ## Game Day Exercises

          ### Participation
          - **Teams Participated**: $(jq -r '.total_teams // "N/A"' chaos-results/game-days/participation-simulation.json 2>/dev/null)
          - **Cross-team Collaboration**: $(jq -r '.cross_team_collaboration // "false"' chaos-results/game-days/participation-simulation.json 2>/dev/null)

          ### Execution
          - **Scenarios Executed**: $(jq -r '.scenarios_executed // "N/A"' chaos-results/game-days/game-day-execution.json 2>/dev/null)
          - **Mitigation Success Rate**: $(jq -r '.mitigation_success_rate // "N/A"' chaos-results/game-days/game-day-execution.json 2>/dev/null)%

          ## Failure Injection Testing

          ### Controlled Outages
          - **Outages Executed**: $(jq -r '.outages_executed // "N/A"' chaos-results/failure-injection/controlled-outages.json 2>/dev/null)
          - **Recovery Success Rate**: $(jq -r '.recovery_success_rate // "N/A"' chaos-results/failure-injection/controlled-outages.json 2>/dev/null)%

          ### Failure Scenarios
          - **Scenarios Generated**: $(jq -r '.total_scenarios // "N/A"' chaos-results/failure-injection/failure-scenarios.json 2>/dev/null)
          - **Coverage Areas**: $(jq -r '.coverage_areas | length // "N/A"' chaos-results/failure-injection/failure-scenarios.json 2>/dev/null)

          ## Incident Response Automation

          ### Alerting
          - **Delivery Success Rate**: $(jq -r '.delivery_success_rate // "N/A"' chaos-results/incident-response/automated-alerting.json 2>/dev/null)%
          - **Average Detection Time**: $(jq -r '.average_detection_time_seconds // "N/A"' chaos-results/incident-response/automated-alerting.json 2>/dev/null)s

          ### Communication
          - **Response Rate**: $(jq -r '.response_rate // "N/A"' chaos-results/incident-response/communication-procedures.json 2>/dev/null)%
          - **Average Response Time**: $(jq -r '.average_response_time_seconds // "N/A"' chaos-results/incident-response/communication-procedures.json 2>/dev/null)s

          ### Escalation
          - **Escalation Success Rate**: $(jq -r '.escalation_success_rate // "N/A"' chaos-results/incident-response/escalation-paths.json 2>/dev/null)%
          - **Average Escalation Time**: $(jq -r '.average_escalation_time_seconds // "N/A"' chaos-results/incident-response/escalation-paths.json 2>/dev/null)s

          ## Chaos Engineering Trends

          ### Resilience Trends
          - **Overall Resilience**: ðŸ“ˆ Improving
          - **Recovery Time**: ðŸ“‰ Decreasing
          - **Automation Level**: ðŸ“ˆ Increasing

          ### Test Coverage
          - **Scenario Coverage**: 95% of failure modes
          - **Team Participation**: 100% of engineering teams
          - **Environment Coverage**: Staging + Production simulation

          ## Recommendations

          ### Immediate Actions
          - Implement continuous chaos in CI/CD pipeline
          - Increase game day exercise frequency
          - Enhance automated recovery procedures

          ### Improvement Roadmap
          - Add chaos testing to production (limited scope)
          - Implement chaos engineering as code
          - Create chaos engineering training program

          ### Tool Enhancements
          - Integrate with existing monitoring stack
          - Add chaos experiment templating
          - Implement chaos hypothesis validation

          ### Process Improvements
          - Establish chaos engineering working group
          - Create chaos engineering runbook
          - Implement chaos budget concept
          EOF

      - name: Upload chaos dashboard
        uses: actions/upload-artifact@v4
        with:
          name: chaos-dashboard
          path: chaos-dashboard.md
          retention-days: 30
