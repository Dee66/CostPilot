metadata:
  product_id: "costpilot"
  product_name: "CostPilot"
  spec_version: "2.1"
  spec_state: "approved"        # draft | approved | deprecated
  version: "1.0.2"
  version_strategy: "semver:api_breaking"
  owner: "CostPilot Founder"
  created_at: "2025-12-05"
  launch_tier: "A"
  source_path: "products/costpilot/"

zero_cost_policy:
  allowed_modes:
    - safe
    - simulate
  default_mode: "safe"
  invariants:
    - "No command or code path may incur real cloud cost."
    - "No IAM permissions are ever required to run CostPilot."
    - "terraform apply is forbidden; terraform plan may be parsed but never executed."
    - "No SDK calls to AWS/GCP/Azure are performed at runtime."
    - "All cost analysis is based on static artifacts only."
    - "No outbound network traffic is allowed by default."
    - "Any step that could create or modify real infrastructure must be blocked."
  forbidden_actions:
    - terraform_apply
    - terraform_plan_execute
    - cloud_resource_create
    - cloud_resource_modify
    - cloud_resource_delete
    - chargeable_api_call
    - real_deployment
    - network_call_external
    - invoke_lambda
    - create_vm
    - allocate_gpu
  simulation_rules:
    terraform:
      simulate_plan: true
      allow_apply: false
    cloud_sdks:
      simulate: true
      forbid_real_calls: true
    network:
      outbound_enabled: false
    deployment:
      dry_run_only: true

overview:
  description:
    short: "GitHub-native, zero-IAM FinOps engine for Terraform."
    long: >
      CostPilot is a zero-permission, GitHub-native FinOps engine that analyzes
      Terraform IaC to detect cost regressions, estimate
      AWS spend, generate autofix patches and snippets, enforce cost SLOs and
      policies, and visualize resource impact via static dependency graphs.
      It runs locally, uses WASM sandboxing, deterministic heuristics, and
      auditable explanations, and never requires IAM or network access.
  problem_statement: >
    Engineering teams and solo builders ship AWS changes without clear visibility
    into cost impact, causing unexpected bill spikes and slow FinOps feedback loops.
  value_proposition: >
    Catch cost regressions pre-merge, in CI, without IAM, external services, or
    complex FinOps setups. CostPilot runs locally on IaC plans, predicts impact,
    explains reasoning, and can auto-generate safe remediation patches.
  target_customers:
    enterprise: true
    startups: true
    individual_devs: true
  primary_use_cases:
    items:
      - id: "uc-01"
        title: "Pre-merge cost regression detection for Terraform plans"
        description: "Detect and block expensive IaC changes directly in PR CI."
      - id: "uc-02"
        title: "Deterministic cost prediction for changed resources"
        description: "Estimate monthly AWS spend impact from IaC diffs using static heuristics."
      - id: "uc-03"
        title: "Cost guardrails with policy-as-code and SLOs"
        description: "Enforce budget and growth constraints using policies and SLOs in CI."
      - id: "uc-04"
        title: "Autofix snippets and patches for high-cost misconfigurations"
        description: "Generate deterministic code fixes or patches for cost issues."
      - id: "uc-05"
        title: "Local trend visualization without a backend"
        description: "Track cost evolution in repo-local artifacts and static visualizations."

market:
  tam: "Teams using AWS with Terraform/CDK who want cost control without full FinOps teams."
  demand_drivers:
    - "Rising AWS bills and cloud waste."
    - "FinOps pressure to shift cost visibility left into CI."
    - "Security and procurement friction around IAM and SaaS agents."
  competition:
    - name: "Generic SaaS FinOps tools"
      differentiation: "CostPilot runs locally, requires zero IAM, and is GitHub-native."
    - name: "In-house scripts and ad-hoc checks"
      differentiation: "CostPilot provides deterministic heuristics, explainability, and governance."
  competitive_advantage:
    - "Zero IAM and zero network by design."
    - "Deterministic, auditable heuristics and explainability."
    - "Local-only, WASM sandboxed execution suitable for enterprises."
    - "Policy-as-code and SLO enforcement built directly into CI."
    - "Static mapping and trend artifacts that can be embedded and shared."
  risk_profile:
    technical_risk: "Medium — requires robust IaC parsing and deterministic heuristics."
    market_risk: "Medium — many FinOps tools exist, but few are zero-IAM/local-first."
    legal_risk: "Low — no customer data or credentials required by default."

product_marketing:
  hero_metric: "Catch 90% of AWS cost regressions before they hit your bill."
  shareable_artifact: "Static cost trend and mapping visualizations embeddable in PRs and docs."
  differentiators:
    - "Zero IAM required — runs entirely on local IaC artifacts."
    - "Deterministic heuristics with auditable explain output."
    - "Patch and snippet autofix with rollback artifacts."
    - "Policy-as-code and SLO burn detection in CI."
  keywords:
    - "FinOps"
    - "Terraform"
    - "AWS cost"
    - "cost governance"
    - "policy as code"
    - "SLO"
    - "IaC analysis"

platform:
  runtime: "wasm_sandbox"
  orchestrator: "local_cli"
  deployable_unit: "signed_cli_binary_plus_wasm"
  cost_mode: "safe"
  core_components:
    cli:
      language: "tbd"
      framework: "native_cli"
      responsibilities:
        - "Expose scan, map, slo, autofix, init, explain commands."
        - "Manage input artifact loading and output serialization."
    analysis_engine:
      language: "tbd"
      framework: "internal"
      responsibilities:
        - "Parse IaC artifacts and derive resource graph."
        - "Run detection, prediction, SLO evaluation, and policy checks."
    wasm_runtime:
      language: "tbd"
      framework: "wasm_vm"
      responsibilities:
        - "Execute deterministic rules within memory and time limits."
    datastore:
      type: "filesystem"
      responsibilities:
        - "Persist baselines, policies, SLOs, trends, and artifacts under .costpilot/."
  architecture_invariants:
    - "All execution must remain deterministic for identical inputs."
    - "No IAM or cloud credentials are ever required or used."
    - "No network egress is allowed by default."
    - "Heuristics and classifiers must be pure functions over input artifacts."
    - "CLI output must conform to documented schemas."
    - "Trend and mapping artifacts must be reproducible."
  capabilities:
    scanning: true
    patching: true
    ai_generation: false           # uses deterministic heuristics and templates, not LLM at runtime
    metrics_output: true
    wasm_safe: true
    deterministic: true
    offline_mode: true

semantics:
  evaluator:
    deterministic: true
    stable_schema: true
    safe_defaults: true
  cost_prediction:
    conservative: true
    uses_cold_start_fallbacks: true
    explicit_assumptions_required: true
  governance:
    policy_as_code: true
    slo_enforcement: true
    exemptions_audited: true

validation_rules:
  config:
    - id: "vr-01"
      rule: "All .costpilot/*.yml and .json files must validate against internal schemas."
    - id: "vr-02"
      rule: "SLO and policy files must define owners and version metadata."
  api:
    - id: "vr-03"
      rule: "CLI JSON outputs must match canonical schemas."
  outputs:
    - id: "vr-04"
      rule: "All timestamps must be UTC ISO-8601."
    - id: "vr-05"
      rule: "Severity scores must be within defined numeric bounds."
    - id: "vr-06"
      rule: "Trend and mapping outputs must be stable between runs."

features:
  must_have:
    auto_gen: false
    automation_level: "partial"
    items:
      - id: "f-01"
        title: "Terraform plan JSON parsing and detection"
        description: "Parse terraform_plan_json and detect built-in cost issues."
      - id: "f-02"
        title: "Deterministic cost prediction"
        description: "Estimate monthly cost deltas using static heuristics and baselines."
      - id: "f-03"
        title: "Explain output"
        description: "Explain predictions with explicit heuristic and assumption references."
      - id: "f-04"
        title: "Autofix snippets"
        description: "Generate manual-apply snippets to remediate common cost regressions."
      - id: "f-05"
        title: "SLO evaluation and burn detection"
        description: "Evaluate cost SLOs and predict burn risk from IaC changes."
      - id: "f-06"
        title: "Policy-as-code enforcement"
        description: "Enforce built-in and user-defined cost policies in CI."
      - id: "f-07"
        title: "Mapping and trend reporting"
        description: "Produce static dependency maps and trend reports from local data."
  should_have:
    auto_gen: false
    items:
      - id: "f-08"
        title: "GitHub Marketplace integration"
        description: "One-click CI installation and billing via Marketplace."
      - id: "f-09"
        title: "VS Code extension"
        description: "Inline feedback on cost effects while editing IaC."
  future:
    auto_gen: false
    items:
      - id: "f-10"
        title: "Full policy language and UI"
        description: "Interactive policy editor and rich governance UI for enterprises."
      - id: "f-11"
        title: "Multi-SLO burn alerting"
        description: "Push notifications for predicted SLO burns (e.g., Slack)."

data_contracts:
  input_schema: "Static IaC artifacts (Terraform plan JSON, CDK diff) plus optional usage hints."
  output_schema: "Structured JSON and static artifacts (trend, mapping, reports) with canonical keys."
  internal_state_schema: "Baselines, SLOs, policies, trends, and mapping metadata stored under .costpilot/."

api:
  base_path: ""          # CLI-first; no HTTP API in v1.
  endpoints: []          # Reserved for future HTTP service mode.
  error_contract:
    format: "canonical"
    fields:
      - code
      - message
      - context
      - trace_id

state_machine:
  states:
    - "INIT"
    - "LOADED"
    - "VALIDATED"
    - "EVALUATED"
    - "CANONICALIZED"
    - "VERIFIED"
    - "EMITTED"
  transitions:
    - id: "sm-01"
      from: "INIT"
      to: "LOADED"
      reason: "Input artifacts loaded."
    - id: "sm-02"
      from: "LOADED"
      to: "VALIDATED"
      reason: "Schemas validated."
    - id: "sm-03"
      from: "VALIDATED"
      to: "EVALUATED"
      reason: "Detection, prediction, SLO and policy checks executed."
    - id: "sm-04"
      from: "EVALUATED"
      to: "CANONICALIZED"
      reason: "Outputs normalized and serialized."
    - id: "sm-05"
      from: "CANONICALIZED"
      to: "VERIFIED"
      reason: "Determinism and invariants verified."
    - id: "sm-06"
      from: "VERIFIED"
      to: "EMITTED"
      reason: "Artifacts emitted to console and .costpilot/."
  events: []
  diagram_id: "costpilot-lifecycle"

security:
  authentication: "none"
  authorization: "local_only"
  secrets_policy: "no_secrets_in_logs"
  secrets_backend: "none"
  path_whitelist:
    - "."
    - ".costpilot/"
  size_limits:
    max_payload_kb: 25600   # ~25MB plans
  invariants:
    - "No IAM credentials are required or used."
    - "No external API calls are ever performed by default."
    - "Telemetry, if enabled, must be opt-in and anonymized."

patching_policy:
  atomic: true
  temp_dir: ".costpilot/.tmp"
  backup_dir: ".costpilot/.backup"
  validations:
    - "syntax"
    - "schema"
  rollback_guarantees:
    - "Every patchable change must have a rollback artifact."
    - "Rollback must leave IaC in a syntactically valid state."

testing:
  unit_tests: true
  integration_tests: true
  e2e_tests: true
  validation_tags:
    - "lint"
    - "regression"
    - "snapshot"
    - "perf"
  required_test_scenarios:
    - id: "t-01"
      title: "Deterministic prediction across platforms"
      steps:
        - "Run prediction on sample plans on ubuntu, debian, macOS."
        - "Verify identical JSON output and hashes."
    - id: "t-02"
      title: "Policy enforcement in warn and block modes"
      steps:
        - "Run CLI with builtin and user policies in both modes."
        - "Verify exit codes and JSON reports."
    - id: "t-03"
      title: "Autofix patch and rollback flow"
      steps:
        - "Generate patch and rollback for supported resources."
        - "Apply patch + rollback in simulation and verify invariants."

ci_cd:
  workflow_file: ".github/workflows/costpilot.yml"
  steps:
    - "validate_schema"
    - "unit"
    - "integration"
    - "snapshot"
    - "wasm"
    - "self_test"
    - "verify"
    - "perf_regression"
  invariants:
    - "verify must pass before merge to main."
    - "snapshot determinism enforced across CI images."
    - "WASM artifacts must be signed."
    - "CI must never execute commands that incur real cloud cost."

observability:
  logs:
    enabled: true
    retention_days: 30
  metrics:
    enabled: true
    endpoint: "/metrics/local"    # local-only or internal
    required_metrics:
      - "scan_count"
      - "error_rate"
      - "latency_p95"
      - "zero_cost_policy_violations"
  tracing:
    enabled: false
  events:
    emit_product_events: true
    event_prefix: "costpilot"

deployment_profiles:
  dev:
    base_image: "local-cli"
    secrets_backend: "env"
    cost_safe: true
  prod:
    base_image: "signed-binary"
    secrets_backend: "none"
    cost_safe: true

pricing:
  tiers:
    - name: "solo"
      price: 29
      limits:
        - "Single user."
        - "Snippet autofix mode."
    - name: "pro"
      price: 99
      limits:
        - "Patch autofix mode."
        - "Rollback artifacts."
        - "Extended reporting."
    - name: "enterprise"
      price: "custom"
      limits:
        - "SSO, exemptions workflow, drift-safe autofix, business unit attribution."
        - "Escrow, audit logging, custom billing."

acquisition:
  channels:
    primary:
      - "hacker_news"
      - "product_hunt"
      - "github_marketplace"
      - "technical_blogs"
      - "terraform_registry"
    secondary:
      - "community_forums"
      - "FinOps_slack"
  launch_assets:
    - "landing_page"
    - "demo_repo"
    - "60s_demo_gif"
    - "github_readme"

acceptance_criteria:
  - id: "ac-01"
    description: "MVP delivers deterministic detect → predict → explain → snippet autofix flow."
  - id: "ac-02"
    description: "Terraform plan fuzz tests pass without crashes and with bounded performance."
  - id: "ac-03"
    description: "Policy-as-code and SLO burn checks operate in warn and block modes."
  - id: "ac-04"
    description: "All outputs are deterministic across supported OS configurations."

release_plan:
  mvp_days: 14
  full_launch_days: 45
  expected_time_to_revenue: 7

support_load:
  per_100_users:
    tickets_per_month: 2
    notes: "Most load expected around IaC parser edge cases and CI integration."

changelog:
  - version: "0.1.0"
    notes: "MVP: detect + predict + explain (top-5) + snippet autofix + CLI/init + GH Action demo."
  - version: "1.0.0"
    notes: "Mermaid mapping, repo snapshots, SLO burn, pro patch autofix, marketplace launch."
  - version: "1.0.1"
    notes: "Builtin policy enforcement (limited), explain expansion, static trend report."
  - version: "2.0.0"
    notes: "Exemptions workflow, policy versioning, drift-safe autofix (beta), Terraform provider."
  - version: "3.0.0"
    notes: "Full policy-as-code, multi-SLO composition, GuardSuite integrations."

x_capabilities:
  detect:
    description: "Identify cost smells, risks, and explosions in IaC."
    categories:
      - "smell"
      - "risk"
      - "explosion"
    detection_rules:
      - "unused_nat_gateway"
      - "overprovisioned_rds"
      - "excessive_lambda_concurrency"
      - "s3_missing_lifecycle"
      - "compute_overprovision"
    outputs:
      - "rule_id"
      - "severity"
      - "resource_id"
      - "regression_type"
      - "severity_score"
    regression_classifier:
      types:
        - "configuration"
        - "scaling"
        - "provisioning"
        - "traffic_inferred"
        - "indirect_cost"
  predict:
    description: "Deterministic, conservative AWS cost estimation for changed resources."
    heuristics_source: "cost_heuristics.json"
    cold_start_inference:
      enabled: true
      defaults:
        dynamodb_rcu: 15
        dynamodb_wcu: 15
        lambda_requests: 1000000
        s3_monthly_gb: 50
        ec2_utilization_pct: 40
    prediction_intervals:
      enabled: true
      range_factor: 0.25
    outputs:
      - "estimated_monthly_cost"
      - "prediction_interval_low"
      - "prediction_interval_high"
      - "heuristic_reference"
      - "confidence_score"
    invariants:
      - "Heuristics must be deterministic and versioned."
      - "prediction_interval_low >= 0."
      - "cold_start assumptions must be flagged in output."
  explain:
    description: "Human-readable, auditable reasoning with heuristic references."
    modes:
      default: "top_5_high_cost_patterns"
      verbose: "full_breakdown"
    outputs:
      - "reasoning_steps"
      - "referenced_heuristics"
      - "referenced_baselines"
      - "regression_type"
      - "confidence"
      - "estimated_fix_effort"
    invariants:
      - "Explanation must reference heuristics file and version."
      - "Sentence ordering must be deterministic."
  autofix:
    description: "Generate deterministic remediation snippets or patches with rollback."
    modes:
      snippet:
        description: "Minimal snippets for manual application."
        availability:
          - "free"
          - "solo"
          - "pro"
          - "enterprise"
      patch:
        description: "Full patch files (.patch) gated by tier."
        availability:
          - "pro"
          - "enterprise"
      drift_safe_patch:
        description: "Patch mode that runs drift checks for high-confidence resources."
        status: "beta"
        availability:
          - "enterprise"
    safety:
      drift_check_before_autofix: true
      supported_resources_for_beta:
        - "aws_instance.instance_type"
        - "aws_s3_bucket.lifecycle_rules"
      safeguards:
        - "no_patch_if_drift_detected"
        - "block_patch_if_policy_version_missing"
    outputs:
      - "snippet_fix"
      - "patch_file"
      - "rollback_patch"
      - "fix_explanation"
  slo:
    description: "Cost SLO definition, evaluation, and burn prediction."
    file: ".costpilot/slo.yml"
    enforcement_modes:
      - "warn"
      - "block"
    slo_burn:
      enabled: true
      outputs:
        - "burn_risk"
        - "projected_cost_after_merge"
        - "estimated_days_to_burn"
    invariants:
      - "SLO evaluation must be deterministic."
      - "Inheritance and composition must be explicit and stable."
  policy_as_code:
    description: "Governance rules enforced in CI via policies and exemptions."
    user_policy_file: ".costpilot/policies.yml"
    enforcement_modes:
      - "warn"
      - "block"
    exemptions_file: ".costpilot/exemptions.yml"
    invariants:
      - "Blocking policies require approval metadata."
      - "Exemptions must include rule, justification, owner, and expiry."
      - "Expired exemptions must fail CI."
  mapping:
    description: "Cross-service impact analysis and dependency visualization."
    formats:
      - "mermaid"
      - "graphviz"
      - "json"
    max_dependency_depth: 5
    cycle_detection_required: true
    outputs:
      - "dependency_graph.json"
      - "mermaid_diagram.md"
      - "graphviz.dot"
    invariants:
      - "No cycles allowed."
      - "Graph must be stable between runs."
  baselines:
    description: "Historical cost expectations used to stabilize prediction."
    file: ".costpilot/baselines.json"
    fields:
      - "resource_id"
      - "expected_cost"
      - "last_updated_at"
      - "justification"
    invariants:
      - "Baselines override small prediction deltas."
      - "Missing baselines for critical resources should warn."
  trend:
    description: "Local trend data and static visualizations for cost evolution."
    file: ".costpilot/trend.json"
    outputs:
      - "trend_report.html"
      - "trend_graph.svg"
    invariants:
      - "Data append-only, timestamps UTC, visualizations deterministic."
  regression_severity:
    description: "Normalized numeric severity score for prioritization and reporting."
    score:
      min: 0
      max: 100
    weighting:
      magnitude: 0.45
      confidence: 0.25
      resource_type_importance: 0.20
      blast_radius: 0.10
    invariants:
      - "Severity score must be deterministic."
      - "Score must stay within [0, 100]."
  attribution:
    description: "Tag-based cost attribution and grouping."
    grouping:
      enabled: true
      by:
        - "module"
        - "service"
        - "environment"
    tiers:
      free:
        outputs:
          - "minimal_resource_trace_id"
      pro:
        outputs:
          - "tag_resolution_map"
      enterprise:
        outputs:
          - "business_unit_cost_breakdown"
          - "service_cost_breakdown"
          - "environment_grouping"
          - "owner_team_report"
    invariants:
      - "Tag keys must be normalized."
      - "Grouping must be stable between runs."

x_cli_contract:
  verbs:
    - "scan"
    - "explain"
    - "map"
    - "autofix"
    - "slo"
    - "init"
  flags:
    - "--json"
    - "--explain"
    - "--graph"
    - "--interactive"
    - "--policy"
    - "--mode <warn|block>"
  commands:
    scan:
      description: "Run detection, prediction, severity scoring."
    explain:
      description: "Produce markdown reasoning breakdown."
    map:
      description: "Output mermaid/graphviz dependency map."
    autofix:
      description: "Generate snippet/patch/rollback."
    slo:
      description: "Check SLOs and burn predictions."
      subcommands:
        - "burn"
    init:
      description: "Create starter config files."
      generates:
        - ".costpilot/policies.yml"
        - ".costpilot/slo.yml"
        - ".costpilot/baselines.json"
        - ".github/workflows/costpilot.yml"
      invariants:
        - "Idempotent generation."
  exit_codes:
    SUCCESS: 0
    POLICY_BLOCK: 2
    SLO_BURN: 3
    INVALID_PLAN: 4
    INTERNAL_ERROR: 5
    DRIFT_DETECTED: 6
  invariants:
    - "CLI output must conform to schemas."
    - "JSON output must use stable key ordering."

x_roadmap:
  mvp:
    version: "0.1.0"
    goals:
      - "Terraform plan parsing and built-in detection."
      - "Deterministic prediction and explain for top-5 patterns."
      - "Snippet autofix and init flow."
      - "Demo repo and 60s PR GIF."
  v1_0_0:
    version: "1.0.0"
    goals:
      - "Mermaid mapping and repo snapshots."
      - "SLO monthly_cost_slo and slo_burn CLI support."
      - "Baselines support and generation."
      - "Pro patch autofix with rollback preview."
  v1_0_1:
    version: "1.0.1"
    goals:
      - "Limited policy-as-code enforcement."
      - "Explain mode expansion."
      - "Trend HTML report."
  v2_0_0:
    version: "2.0.0"
    goals:
      - "Exemption workflow and policy metadata."
      - "Drift-safe autofix (beta)."
      - "Terraform provider integration."
  v3_0_0:
    version: "3.0.0"
    goals:
      - "Full policy language + UI."
      - "Multi-SLO composition and burn alerting."
      - "GuardSuite telemetry integrations."
