# CostPilot Policy Configuration
version: "1.0"

# Budget policies
policies:
  - name: "Production Budget Limit"
    rule: "monthly_cost <= 5000"
    action: block
    severity: CRITICAL
    tags:
      - environment: production
    
  - name: "Development Budget Warning"
    rule: "monthly_cost > 1000"
    action: warn
    severity: MEDIUM
    tags:
      - environment: development
  
  - name: "Instance Type Restrictions"
    rule: "instance_type in ['t3.micro', 't3.small', 't3.medium', 't3.large']"
    action: require_approval
    severity: HIGH
    resources:
      - aws_instance
      - aws_autoscaling_group
  
  - name: "NAT Gateway Limit"
    rule: "resource_count <= 2"
    action: block
    severity: HIGH
    resources:
      - aws_nat_gateway
  
  - name: "Lambda Concurrency Limit"
    rule: "reserved_concurrent_executions != null"
    action: warn
    severity: MEDIUM
    resources:
      - aws_lambda_function
  
  - name: "S3 Lifecycle Rules Required"
    rule: "lifecycle_rule != null"
    action: warn
    severity: LOW
    resources:
      - aws_s3_bucket
  
  - name: "Cost Regression Threshold"
    rule: "cost_increase_percent <= 20"
    action: require_approval
    severity: HIGH

# Exemptions
exemptions:
  - id: EXP-001
    policy: "Production Budget Limit"
    resource: "module.analytics.aws_emr_cluster"
    justification: "Q4 data processing spike - temporary"
    expires_at: "2026-03-31"
    approved_by: "tech-lead@company.com"
    ticket_ref: "JIRA-1234"

# Approval workflows
approval_workflows:
  require_approval_for:
    - cost_increase_percent: 30  # Require approval for 30%+ increases
    - monthly_cost: 10000        # Require approval for $10k+ changes
    - instance_types:            # Require approval for large instances
        - "*.2xlarge"
        - "*.4xlarge"
        - "*.8xlarge"
  
  approvers:
    - email: "tech-lead@company.com"
      slack: "@tech-lead"
    - email: "finops@company.com"
      slack: "@finops-team"

# Baseline configuration
baseline:
  file: ".costpilot/baseline.json"
  auto_update: false  # Set true to auto-update on main branch
  regression_threshold: 10  # Percent increase to flag as regression

# SLO configuration
slo:
  file: ".costpilot/slo.json"
  check_on_pr: true
  fail_on_breach: true
